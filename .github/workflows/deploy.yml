name: Build and Deploy (Self-Hosted)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    # ÂÖ≥ÈîÆ‰øÆÊîπÔºöÊåáÂÆöÂú®‰Ω†Ëá™Â∑±ÊúçÂä°Âô®‰∏äËøêË°åÔºåÂΩªÂ∫ïËß£ÂÜ≥ÁΩëÁªúÊÖ¢ÁöÑÈóÆÈ¢ò
    runs-on: self-hosted

    # ÁéØÂ¢ÉÂèòÈáèÔºöÂÆö‰πâ‰Ω†ÁöÑÈÉ®ÁΩ≤ÁªùÂØπË∑ØÂæÑ
    env:
      DEPLOY_PATH: /opt/trace

    steps:
    # 1. ÊãâÂèñ‰ª£Á†ÅÂà∞‰Ω†ÁöÑÊúçÂä°Âô®‰∏¥Êó∂ÁõÆÂΩï
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. ÁéØÂ¢ÉÈÖçÁΩÆ
    # Ê≥®ÊÑèÔºöSelf-hosted Runner ‰ºöËá™Âä®ÁºìÂ≠ò Node/Go ÁéØÂ¢ÉÔºå
    # Á¨¨‰∫åÊ¨°ËøêË°åÊó∂Ëøô‰∏ÄÊ≠•‰ºöÈùûÂ∏∏Âø´ÔºàÁßíÁ∫ßÔºâ„ÄÇ
    # - name: Setup Node.js
    #   uses: actions/setup-node@v3
    #   with:
    #     node-version: '22'
    #     cache: 'npm'
    #     cache-dependency-path: admin/package-lock.json
        
    # - name: Setup Go
    #   uses: actions/setup-go@v4
    #   with:
    #     go-version: '1.21'

    # 3. ÊûÑÂª∫ÂâçÁ´Ø
    - name: Build Frontend
      run: |
        cd admin
        npm ci
        npm run build
        
    # 4. ÂáÜÂ§áÂêéÁ´ØÈùôÊÄÅÊñá‰ª∂
    - name: Prepare Backend Static Files
      run: |
        rm -rf server/dist
        mkdir -p server/dist
        cp -r admin/dist/* server/dist/
        
    # 5. ÊûÑÂª∫ÂêéÁ´Ø (Áõ¥Êé•ÁîüÊàê‰∫åËøõÂà∂Êñá‰ª∂)
    - name: Build Backend for Linux
      run: |
        cd server
        # Âõ†‰∏∫ÊòØÂú®Êú¨Êú∫Ë∑ëÔºåÂÖ∂ÂÆûÂèØ‰ª•Áõ¥Êé• go buildÔºå‰ΩÜ‰øùÁïôÂèÇÊï∞Á°Æ‰øùÂÖºÂÆπÊÄß
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o trace-server-linux main.go
        
    # 6. ÂÆâÂÖ®ÈÉ®ÁΩ≤ÔºöÂÖàÈ™åËØÅÊñ∞ÁâàÊú¨ËÉΩÂêØÂä®ÔºåÂÜçÂàáÊç¢
    - name: Deploy Locally (Safe Rollback)
      run: |
        echo "üöÄ Starting safe deployment..."
        
        DEPLOY_DIR="${{ env.DEPLOY_PATH }}/server"
        STAGING_DIR="${{ env.DEPLOY_PATH }}/staging"
        TEST_PORT=18080
        
        # Á°Æ‰øùÁõÆÂΩïÂ≠òÂú®
        mkdir -p $DEPLOY_DIR
        mkdir -p $STAGING_DIR
        
        # ========== Èò∂ÊÆµ1: ÂáÜÂ§áÊñ∞ÁâàÊú¨Âà∞ staging ÁõÆÂΩï ==========
        echo "üì¶ Stage 1: Preparing new version in staging..."
        rm -rf $STAGING_DIR/*
        cp server/trace-server-linux $STAGING_DIR/
        cp -r server/dist $STAGING_DIR/
        chmod +x $STAGING_DIR/trace-server-linux
        
        # ========== Èò∂ÊÆµ2: ÊµãËØïÊñ∞ÁâàÊú¨ËÉΩÂê¶ÂêØÂä® ==========
        echo "üß™ Stage 2: Testing new version on port $TEST_PORT..."
        cd $STAGING_DIR
        
        # ÂêØÂä®ÊµãËØïÂÆû‰æãÔºà‰ΩøÁî®‰∏çÂêåÁ´ØÂè£Ôºå‰∏çÂΩ±ÂìçÁîü‰∫ßÔºâ
        PORT=$TEST_PORT nohup ./trace-server-linux > test.log 2>&1 &
        TEST_PID=$!
        
        # Á≠âÂæÖÂêØÂä®
        sleep 3
        
        # Ê£ÄÊü•ËøõÁ®ãÊòØÂê¶Â≠òÊ¥ª
        if ! ps -p $TEST_PID > /dev/null 2>&1; then
            echo "‚ùå New version failed to start! Keeping old version running."
            echo "=== Test Log ==="
            cat test.log
            echo "================"
            exit 1
        fi
        
        # ÂÅ•Â∫∑Ê£ÄÊü•ÔºöÂ∞ùËØïËÆøÈóÆ API
        if ! curl -sf http://localhost:$TEST_PORT/api/health > /dev/null 2>&1; then
            # Â¶ÇÊûúÊ≤°Êúâ health Êé•Âè£ÔºåÊ£ÄÊü•Á´ØÂè£ÊòØÂê¶Âú®ÁõëÂê¨
            if ! ss -tlnp | grep -q ":$TEST_PORT"; then
                echo "‚ùå New version is not responding! Keeping old version."
                kill $TEST_PID 2>/dev/null || true
                cat test.log
                exit 1
            fi
        fi
        
        echo "‚úÖ New version passed health check!"
        
        # ÂÅúÊ≠¢ÊµãËØïÂÆû‰æã
        kill $TEST_PID 2>/dev/null || true
        sleep 1
        
        # ========== Èò∂ÊÆµ3: Ê≠£ÂºèÂàáÊç¢ ==========
        echo "üîÑ Stage 3: Switching to new version..."
        
        # ÂÅúÊ≠¢ÊóßÁöÑÁîü‰∫ßÊúçÂä°
        killall trace-server-linux 2>/dev/null || true
        sleep 1
        
        # Â§á‰ªΩÊóßÁâàÊú¨ÔºàÂèØÈÄâÔºâ
        if [ -f "$DEPLOY_DIR/trace-server-linux" ]; then
            cp $DEPLOY_DIR/trace-server-linux $DEPLOY_DIR/trace-server-linux.bak 2>/dev/null || true
        fi
        
        # ÊõøÊç¢‰∏∫Êñ∞ÁâàÊú¨
        rm -rf $DEPLOY_DIR/dist
        cp $STAGING_DIR/trace-server-linux $DEPLOY_DIR/
        cp -r $STAGING_DIR/dist $DEPLOY_DIR/
        
        # ÂêØÂä®Êñ∞ÁâàÊú¨
        cd $DEPLOY_DIR
        nohup ./trace-server-linux > server.log 2>&1 &
        PROD_PID=$!
        
        sleep 2
        
        if ps -p $PROD_PID > /dev/null 2>&1; then
            echo "‚úÖ Deployment successful! Server running (PID $PROD_PID)"
            exit 0
        else
            echo "‚ùå Production start failed! Attempting rollback..."
            
            # Â∞ùËØïÂõûÊªöÂà∞ÊóßÁâàÊú¨
            if [ -f "$DEPLOY_DIR/trace-server-linux.bak" ]; then
                mv $DEPLOY_DIR/trace-server-linux.bak $DEPLOY_DIR/trace-server-linux
                nohup ./trace-server-linux > server.log 2>&1 &
                sleep 2
                if ps aux | grep -v grep | grep trace-server-linux > /dev/null; then
                    echo "‚ö†Ô∏è Rolled back to previous version"
                fi
            fi
            
            cat server.log
            exit 1
        fi