name: Build and Deploy (Self-Hosted)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    # å…³é”®ä¿®æ”¹ï¼šæŒ‡å®šåœ¨ä½ è‡ªå·±æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œå½»åº•è§£å†³ç½‘ç»œæ…¢çš„é—®é¢˜
    runs-on: self-hosted

    # ç¯å¢ƒå˜é‡ï¼šå®šä¹‰ä½ çš„éƒ¨ç½²ç»å¯¹è·¯å¾„
    env:
      DEPLOY_PATH: /opt/trace

    steps:
    # 1. æ‹‰å–ä»£ç åˆ°ä½ çš„æœåŠ¡å™¨ä¸´æ—¶ç›®å½•
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. ç¯å¢ƒé…ç½®
    # æ³¨æ„ï¼šSelf-hosted Runner ä¼šè‡ªåŠ¨ç¼“å­˜ Node/Go ç¯å¢ƒï¼Œ
    # ç¬¬äºŒæ¬¡è¿è¡Œæ—¶è¿™ä¸€æ­¥ä¼šéå¸¸å¿«ï¼ˆç§’çº§ï¼‰ã€‚
    # - name: Setup Node.js
    #   uses: actions/setup-node@v3
    #   with:
    #     node-version: '22'
    #     cache: 'npm'
    #     cache-dependency-path: admin/package-lock.json
        
    # - name: Setup Go
    #   uses: actions/setup-go@v4
    #   with:
    #     go-version: '1.21'

    # 3. æ„å»ºå‰ç«¯
    - name: Build Frontend
      run: |
        cd admin
        npm ci
        npm run build
        
    # 4. å‡†å¤‡åç«¯é™æ€æ–‡ä»¶
    - name: Prepare Backend Static Files
      run: |
        rm -rf server/dist
        mkdir -p server/dist
        cp -r admin/dist/* server/dist/
        
    # 5. æ„å»ºåç«¯ (ç›´æ¥ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶)
    - name: Build Backend for Linux
      run: |
        cd server
        # å› ä¸ºæ˜¯åœ¨æœ¬æœºè·‘ï¼Œå…¶å®å¯ä»¥ç›´æ¥ go buildï¼Œä½†ä¿ç•™å‚æ•°ç¡®ä¿å…¼å®¹æ€§
        CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -o trace-server-linux main.go
        
    # 6. å®‰å…¨éƒ¨ç½²ï¼šä½¿ç”¨ systemd ç®¡ç†æœåŠ¡
    - name: Deploy with systemd
      run: |
        echo "ğŸš€ Starting deployment..."
        
        DEPLOY_DIR="${{ env.DEPLOY_PATH }}/server"
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p $DEPLOY_DIR
        
        # ========== é˜¶æ®µ0: ç¡®ä¿ systemd æœåŠ¡å­˜åœ¨ ==========
        if [ ! -f /etc/systemd/system/trace.service ]; then
            echo "ğŸ“ Creating systemd service file..."
            cat > /etc/systemd/system/trace.service << 'EOF'
[Unit]
Description=Trace Server
After=network.target

[Service]
Type=simple
WorkingDirectory=/opt/trace/server
ExecStart=/opt/trace/server/trace-server-linux
Restart=always
RestartSec=5
Environment=GIN_MODE=release

[Install]
WantedBy=multi-user.target
EOF
            systemctl daemon-reload
            systemctl enable trace
        fi
        
        # ========== é˜¶æ®µ1: å¤‡ä»½æ—§ç‰ˆæœ¬ ==========
        echo "ğŸ“¦ Stage 1: Backup old version..."
        if [ -f "$DEPLOY_DIR/trace-server-linux" ]; then
            cp $DEPLOY_DIR/trace-server-linux $DEPLOY_DIR/trace-server-linux.bak 2>/dev/null || true
        fi
        
        # ========== é˜¶æ®µ2: éƒ¨ç½²æ–°ç‰ˆæœ¬ ==========
        echo "ğŸ“¦ Stage 2: Deploying new version..."
        rm -rf $DEPLOY_DIR/dist
        cp server/trace-server-linux $DEPLOY_DIR/
        cp -r server/dist $DEPLOY_DIR/
        chmod +x $DEPLOY_DIR/trace-server-linux
        
        # ========== é˜¶æ®µ3: ä½¿ç”¨ systemd é‡å¯æœåŠ¡ ==========
        echo "ğŸ”„ Stage 3: Restarting service via systemd..."
        systemctl restart trace
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        sleep 3
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        if systemctl is-active --quiet trace; then
            echo "âœ… Deployment successful! Service is running."
            systemctl status trace --no-pager
            exit 0
        else
            echo "âŒ Service failed to start! Attempting rollback..."
            
            # å›æ»šåˆ°æ—§ç‰ˆæœ¬
            if [ -f "$DEPLOY_DIR/trace-server-linux.bak" ]; then
                mv $DEPLOY_DIR/trace-server-linux.bak $DEPLOY_DIR/trace-server-linux
                systemctl restart trace
                sleep 2
                if systemctl is-active --quiet trace; then
                    echo "âš ï¸ Rolled back to previous version"
                else
                    echo "âŒ Rollback also failed!"
                fi
            fi
            
            # æ˜¾ç¤ºé”™è¯¯æ—¥å¿—
            journalctl -u trace -n 50 --no-pager
            exit 1
        fi